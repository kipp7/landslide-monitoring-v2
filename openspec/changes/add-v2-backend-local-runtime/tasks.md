## 1. 本地运行基线（Local Runtime Baseline）
- [ ] 1.1 盘点当前 `infra/compose` 与本地脚本现状（能否一键起 DB）
- [x] 1.2 明确端口分配与冲突策略（3000/5174/8080 等）
- [ ] 1.3 明确最小依赖：Postgres + ClickHouse（可按服务拆分）
- [x] 1.4 输出一份“本地启动 SOP”（不依赖个人环境）
- [x] 1.5 输出一键启动脚本（Windows PowerShell）
- [ ] 1.6 输出停机/清理脚本（停止 compose、清理 volume 可选）
- [x] 1.7 提供 demo 数据初始化脚本（最小可用数据）
- [x] 1.8 增加本地健康检查总览脚本（检查端口/DB/进程）
- [x] 1.9 文档化“常见问题”与排查路径（端口占用/权限）

## 2. API Service 可构建可启动
- [ ] 2.1 `npm -w services/api run build` 可通过
- [ ] 2.2 `npm -w services/api run start` 可启动并监听预期端口
- [ ] 2.3 `/health` 200 OK（含基本信息：version、uptime）
- [ ] 2.4 增加 `dev` 脚本（热重载可选）
- [ ] 2.5 统一日志级别（debug/info/warn/error）与默认输出
- [ ] 2.6 增加 CORS 策略（供 `apps/desk` 联调）
- [ ] 2.7 输出 API 路由清单（启动时打印或提供 `/routes`）
- [ ] 2.8 实现 graceful shutdown（退出时关闭 DB 连接）
- [ ] 2.9 启动自检：配置缺失时给出可读提示并退出
- [ ] 2.10 增加最小 smoke（启动后请求 `/health`）脚本

## 3. 配置与环境变量
- [ ] 3.1 清理/补齐 `services/api/.env.example`（仅保留必要项）
- [ ] 3.2 统一本地默认配置（无 `.env` 也能启动，或启动时给出明确提示）
- [ ] 3.3 认证开发通行证：`Authorization: Bearer dev`（仅开发环境）
- [ ] 3.4 区分 dev/test/prod 配置层（优先 dev 默认）
- [ ] 3.5 统一配置加载顺序（env -> .env -> defaults）
- [ ] 3.6 敏感信息不落盘策略（仅 env，不提交到仓库）
- [ ] 3.7 增加 config dump 诊断开关（隐藏敏感字段）
- [ ] 3.8 定义桌面端对接的 baseUrl 约定与文档（如 `DESK_API_BASE_URL`）

## 4. 数据库连通性
- [ ] 4.1 Postgres 连接成功（启动时自检并输出清晰日志）
- [ ] 4.2 ClickHouse 连接成功（可延迟初始化，但必须可诊断）
- [ ] 4.3 增加最小 schema 初始化策略（迁移/SQL 脚本/启动检查）
- [ ] 4.4 确定迁移策略（迁移工具/SQL 目录/启动时检查）
- [ ] 4.5 ClickHouse 初始化：database/table/TTL（按最小写入设计）
- [ ] 4.6 DB 健康检查：输出连接耗时与错误详情（脱敏）
- [ ] 4.7 连接池与超时配置（Postgres/ClickHouse）
- [ ] 4.8 Postgres demo seed（站点/设备/传感器/告警最小集）
- [ ] 4.9 ClickHouse demo seed（时间序列最小集，可选）
- [ ] 4.10 启动日志输出 DB 版本与目标地址（脱敏）

## 5. 最小联调接口（只读优先）
- [ ] 5.1 站点树/站点列表查询（供设备管理/GPS 页面）
- [ ] 5.2 设备列表与状态查询（供设备管理页面）
- [ ] 5.3 GPS 时间序列查询（供 GPS 监测趋势/表格）
- [ ] 5.4 告警事件列表（供首页/大屏/通知）
- [ ] 5.5 站点详情查询（含设备/传感器摘要）
- [ ] 5.6 设备详情查询（含传感器列表与最后上报）
- [ ] 5.7 设备实时数据查询（最近一条/最近 N 条）
- [ ] 5.8 告警详情查询（含关联站点/设备/测点）
- [ ] 5.9 系统字典/枚举接口（供前端统一显示）
- [ ] 5.10 错误返回 shape 对齐前端 `ApiError` contract

## 6. 可观测性与排障
- [ ] 6.1 启动日志包含：环境、端口、DB 连接结果
- [ ] 6.2 请求日志与错误日志可区分（必要时带 requestId）
- [ ] 6.3 关键失败时返回可读错误（不要只抛栈）
- [ ] 6.4 增加慢请求日志（阈值可配置）与耗时统计

## 7. 验收
- [ ] 7.1 新机器按 SOP 启动成功（DB + API）
- [ ] 7.2 `curl http://localhost:<port>/health` 返回 200
- [ ] 7.3 桌面端切换 HTTP 模式时，至少能请求到一个只读接口（不崩溃）

## 8. 告警与处置接口（读写，面向实际运行）
- [ ] 8.1 明确告警数据模型与最小字段（站点/设备/传感器/等级/阈值/时间/状态）
- [ ] 8.2 增加 Postgres 迁移：告警表/规则表/处置记录表（最小可用）
- [ ] 8.3 增加 `/alerts` 列表接口：分页/过滤/排序（对齐前端 Contract）
- [ ] 8.4 增加 `/alerts/:id` 详情接口：返回关联站点/设备与最近数据点（可选）
- [ ] 8.5 增加 `/alerts/:id/ack`：确认告警（支持备注）
- [ ] 8.6 增加 `/alerts/:id/assign`：指派责任人/班组（先占位）
- [ ] 8.7 增加 `/alerts/:id/close`：关闭告警（结论/原因/措施，先占位）
- [ ] 8.8 增加 `/alerts/:id/escalate`：升降级（先占位）
- [ ] 8.9 增加 `/alerts/silence`：静默策略（按站点/设备/时间段）
- [ ] 8.10 增加 `/alerts/stats`：首页/大屏统计（按等级/状态）
- [ ] 8.11 增加 `/alerts/trend`：告警趋势（24h/7d/30d）
- [ ] 8.12 统一错误返回：校验错误/权限错误/不存在（对齐 ApiError）
- [ ] 8.13 告警处置写入审计日志（actor/action/resource/time/result）
- [ ] 8.14 告警写入接口增加幂等性策略（避免重复提交）
- [ ] 8.15 告警写入接口增加最小鉴权保护（dev token/权限）
- [ ] 8.16 Demo seed：生成可复现告警事件（与站点/设备关联）
- [ ] 8.17 增加“告警推送”机制占位（SSE/WebSocket 可选，先文档化）
- [ ] 8.18 增加缓存策略：告警列表短缓存/详情按需缓存（可选）
- [ ] 8.19 统一时间与时区处理（输入/输出一致，避免前端误解）
- [ ] 8.20 文档：告警 API 示例与常见错误码

## 9. 工单/待办与处置闭环（先最小实现）
- [ ] 9.1 明确工单/待办最小字段（标题、优先级、状态、关联告警/站点/设备）
- [ ] 9.2 增加 Postgres 迁移：工单表/评论表/附件元数据表
- [ ] 9.3 增加 `/workorders` 列表接口：分页/过滤/排序（status/priority/assignee/timeRange）
- [ ] 9.4 增加 `/workorders` 创建接口：校验 + 默认状态（Mock 可用）
- [ ] 9.5 增加 `/workorders/:id` 详情接口：含评论与附件元数据
- [ ] 9.6 增加 `/workorders/:id` 更新接口：编辑字段（标题/描述/关联对象）
- [ ] 9.7 增加 `/workorders/:id/transition`：状态流转（新建->处理中->待复核->已完成）
- [ ] 9.8 增加 `/workorders/:id/comment`：追加处理记录（文本为主）
- [ ] 9.9 增加 `/workorders/:id/attach`：附件元数据登记（文件由桌面端处理）
- [ ] 9.10 增加 `/workorders/export`：导出清单（CSV 先，占位）
- [ ] 9.11 增加 `/todos/suggestions`：系统建议（离线/预警/缺基线）
- [ ] 9.12 增加 `/todos`：人工待办 CRUD（可与工单复用或单独表）
- [ ] 9.13 支持“从告警一键生成工单”接口（alertId -> workorder）
- [ ] 9.14 工单/待办写入审计日志（最小）
- [ ] 9.15 文档：工单/待办 API 与示例

## 10. 数据写入与同步（传感器/时间序列）
- [ ] 10.1 明确数据接入策略：设备上报 -> API -> DB（Postgres 元数据 + ClickHouse 时序）
- [ ] 10.2 增加 `/ingest/telemetry` 写入接口（最小：deviceId/ts/metrics）
- [ ] 10.3 增加输入校验：时间/单位/范围（避免脏数据进入）
- [ ] 10.4 写入时更新设备最后上报时间与在线状态（device_status）
- [ ] 10.5 ClickHouse 写入：创建最小表（按 deviceId + ts 分区）
- [ ] 10.6 ClickHouse 写入：支持 GNSS 位移/雨量/倾角/温湿度等指标列（可逐步）
- [ ] 10.7 增加缺失数据策略：空值与缺失标记（不要用 0 代替）
- [ ] 10.8 增加去重/幂等：同 deviceId+ts 的写入策略
- [ ] 10.9 增加批量写入：降低接口调用频率（现场网络差场景）
- [ ] 10.10 增加“数据质量”计算：缺失率、延迟、异常值计数（供大屏）
- [ ] 10.11 增加 `/devices/:id/recent`：最近 N 条数据查询
- [ ] 10.12 增加 `/gps/:deviceId/series`：按时间范围查询下采样曲线
- [ ] 10.13 增加“雨量累计”查询（小时/日累计，供告警与大屏）
- [ ] 10.14 增加 demo 写入脚本：模拟设备定时上报（便于联调）
- [ ] 10.15 文档：数据写入协议（字段/单位/频率/示例）

## 11. 权限与审计（最小可用）
- [ ] 11.1 明确最小用户模型：admin/viewer（用户名/密码或 dev token）
- [ ] 11.2 增加 `/auth/login` 与 `/auth/logout` 的最小实现（或 dev 直通）
- [ ] 11.3 增加中间件：解析 token 并注入 user（request.user）
- [ ] 11.4 关键写接口（告警/工单/配置）增加权限校验（admin）
- [ ] 11.5 增加 `/me`：返回当前用户信息与角色（供前端显示）
- [ ] 11.6 增加 `/audit`：审计日志查询接口（分页/过滤）
- [ ] 11.7 审计日志脱敏：不记录密码/token 等敏感字段
- [ ] 11.8 请求级 requestId：贯穿日志与错误返回（便于排障）
- [ ] 11.9 错误码规范化：401/403/404/409/422/500 的返回 shape
- [ ] 11.10 文档：权限矩阵（哪些接口/操作需要 admin）

## 12. 生产可用性与现场部署（Win11 桌面端联调）
- [ ] 12.1 增加一键“生产模式”启动脚本（API + DB）与环境示例
- [ ] 12.2 Docker Compose：为 API 增加资源限制与重启策略（restart policy）
- [ ] 12.3 增加 readiness/liveness：区分“启动中/可服务”
- [ ] 12.4 日志落盘与轮转策略（docker 日志/文件日志二选一）
- [ ] 12.5 增加 DB 备份脚本（Postgres）与恢复说明
- [ ] 12.6 增加 ClickHouse 备份/导出策略说明（最小）
- [ ] 12.7 增加“现场诊断”接口：返回关键配置与依赖状态（脱敏）
- [ ] 12.8 兼容桌面端跨域与本机访问（CORS 与 127.0.0.1 策略）
- [ ] 12.9 增加“数据回放”模式占位（用于复盘历史滑坡事件）
- [ ] 12.10 验收：桌面端 HTTP 模式可读取站点/设备/GPS/告警至少 4 类接口
