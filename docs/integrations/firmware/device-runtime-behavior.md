# 设备运行行为与重连策略（固件必须遵守）

本文件定义设备端的“运行行为契约”，避免实现阶段出现：

- 断电写坏配置导致永远无法上线
- 弱网下疯狂重连造成 Broker 连接风暴
- 上报与命令处理互相阻塞导致丢数据/无回执

## 1. 连接与重连（Backoff）

### 1.1 连接失败退避（必须）

当 MQTT 连接失败或鉴权失败时，必须指数退避重试：

- 初始延迟：1s
- 指数增长：×2
- 最大延迟：60s（或更大，按设备能力）
- 每次成功连接后退避计数清零

约束：

- 禁止紧密循环重连（会打爆 EMQX 与网络）
- 在退避期间仍需维持看门狗与传感器采样（避免死锁）

### 1.2 鉴权失败处理（必须）

如果 Broker 返回鉴权失败（密码错误/被吊销）：

- 进入“降频重试模式”（例如 60s~10min）并打出可定位错误码
- 不允许继续以高频率重连（避免被封/影响其他设备）
- 不允许在日志/串口输出 `device_secret`

## 2. 断电安全存储（A/B Slot）

身份与关键配置（例如 report_interval）必须使用 A/B 双槽存储：

- SlotA、SlotB 各存一份：`payload + version + crc`
- 写入流程：
  1) 写入非当前槽
  2) 校验 CRC
  3) 更新“当前槽指针”
- 启动流程：
  - 优先读取版本更高且 CRC 正确的槽
  - 两槽都坏则进入“安全模式”（只允许串口恢复/重新烧录）

## 3. 任务划分（避免阻塞）

推荐最小任务模型（可按 RTOS/裸机实现等价）：

- `net_task`：负责 MQTT 连接、收发、心跳
- `sample_task`：负责传感器采样与本地缓存
- `report_task`：按 report_interval 组包并 publish（使用最新值/聚合）
- `command_task`：处理命令并 ACK（不得阻塞 net_task）

## 4. 消息 QoS 与幂等提示

建议：

- Telemetry：QoS 0 或 QoS 1（取决于网络与成本）
  - QoS 1 会增加开销，但能减少丢包
  - 无论 QoS，后端都必须按 `device_id + seq` 做去重/乱序处理（最终一致）
- Command/Ack：QoS 1（尽量保证可达）

注意：

- 设备端的 `seq` 用于“辅助去重/排查乱序”，不能作为唯一真相
- 后端以 `received_ts` 为主时间，`event_ts` 用于对齐设备自身时钟（如果可靠）

## 5. 限流与保护（设备端）

设备端应具备最小自我保护：

- payload 过大时分包/降采样（后续可扩展协议）
- sensor 读数异常（NaN/Inf）应在上报前清洗为 null 或字符串错误码
- 同一周期内避免发布多条重复消息（除非明确需要）

