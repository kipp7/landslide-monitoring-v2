# é©¬è¾¾é—®é¢˜å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸš¨ **é—®é¢˜æ€»ç»“**

ç”¨æˆ·åé¦ˆçš„é—®é¢˜ï¼š
1. **é©¬è¾¾ä¸ä¼šåœæ­¢**ï¼šå‘é€åœæ­¢å‘½ä»¤åé©¬è¾¾ç»§ç»­è½¬åŠ¨
2. **å®šæ—¶ä¸å‡†ç¡®**ï¼šè®¾ç½®5ç§’è¿è¡Œæ—¶é—´ï¼Œä½†é©¬è¾¾ä¸€ç›´è½¬åŠ¨
3. **ç³»ç»Ÿé˜»å¡**ï¼šé©¬è¾¾è¿è¡ŒæœŸé—´æ— æ³•å“åº”åœæ­¢å‘½ä»¤

## ğŸ”§ **å®Œæ•´ä¿®å¤æ–¹æ¡ˆ**

### **ä¿®å¤1ï¼šæ­£ç¡®çš„é©¬è¾¾åœæ­¢æ–¹æ³•**
```c
// âŒ åŸå§‹é—®é¢˜ä»£ç 
void Motor_Off(void) {
    IoTPwmStart(MOTOR_PWM, 1, PWM_FREQ_HZ);  // åªæ˜¯è®¾ç½®æœ€å°å ç©ºæ¯”ï¼Œé©¬è¾¾ä»åœ¨è½¬
}

// âœ… ä¿®å¤åçš„ä»£ç 
void Motor_Off(void) {
    IoTPwmStop(MOTOR_PWM);  // å®Œå…¨åœæ­¢PWMè¾“å‡ºï¼Œé©¬è¾¾å½»åº•åœæ­¢
    
    // æ¸…é™¤è‡ªåŠ¨åœæ­¢å®šæ—¶å™¨
    g_motor_auto_stop_enabled = false;
    g_motor_start_time = 0;
    g_motor_duration_ms = 0;
    printf("Motor stopped and auto-stop timer cleared\n");
}
```

### **ä¿®å¤2ï¼šéé˜»å¡å®šæ—¶å™¨ç³»ç»Ÿ**
```c
// âŒ åŸå§‹é˜»å¡ä»£ç 
if (duration_ms > 0) {
    LOS_Msleep(duration_ms);  // é˜»å¡5000æ¯«ç§’ï¼Œç³»ç»Ÿæ— å“åº”
    Motor_Off();
}

// âœ… ä¿®å¤åçš„éé˜»å¡ä»£ç 
if (duration_ms > 0) {
    g_motor_start_time = LOS_TickCountGet();
    g_motor_duration_ms = duration_ms;
    g_motor_auto_stop_enabled = true;
    printf("Motor auto-stop timer set: start_time=%d, duration=%d ms\n", 
           g_motor_start_time, duration_ms);
}
```

### **ä¿®å¤3ï¼šä¸»å¾ªç¯å®šæ—¶å™¨æ£€æŸ¥**
```c
void Motor_CheckAutoStop(void) {
    if (!g_motor_auto_stop_enabled) {
        return;
    }
    
    uint32_t current_time = LOS_TickCountGet();
    uint32_t elapsed_ticks = current_time - g_motor_start_time;
    uint32_t elapsed_ms = elapsed_ticks * 1000 / OS_SYS_CLOCK;
    
    // æ¯ç§’æ‰“å°è°ƒè¯•ä¿¡æ¯
    static uint32_t last_debug_time = 0;
    if (current_time - last_debug_time >= OS_SYS_CLOCK) {
        printf("Motor running: %d/%d ms (ticks: %d)\n", 
               elapsed_ms, g_motor_duration_ms, elapsed_ticks);
        last_debug_time = current_time;
    }
    
    if (elapsed_ms >= g_motor_duration_ms) {
        printf("*** Motor auto-stop triggered after %d milliseconds ***\n", elapsed_ms);
        Motor_Off();
    }
}
```

### **ä¿®å¤4ï¼šä¸»å¾ªç¯é›†æˆ**
```c
// åœ¨SensorCollectionTaskä¸»å¾ªç¯ä¸­æ·»åŠ 
while (g_system_state == SYSTEM_STATE_RUNNING || g_system_state == SYSTEM_STATE_WARNING) {
    // ... ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›† ...
    
    // æ£€æŸ¥é©¬è¾¾è‡ªåŠ¨åœæ­¢ï¼ˆéé˜»å¡ï¼Œæ¯66.7msæ£€æŸ¥ä¸€æ¬¡ï¼‰
    Motor_CheckAutoStop();
    
    // ç­‰å¾…ä¸‹æ¬¡é‡‡æ ·
    LOS_Msleep(sample_interval_ms);  // 66.7ms (15Hzé‡‡æ ·ç‡)
}
```

## ğŸ¯ **é¢„æœŸä¿®å¤æ•ˆæœ**

### **âœ… ç°åœ¨åº”è¯¥çœ‹åˆ°çš„è¡Œä¸º**

#### **å¯åŠ¨å‘½ä»¤æµ‹è¯•**
```json
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": true,
    "speed": 80,
    "direction": 1,
    "duration": 5000
  }
}
```

**é¢„æœŸä¸²å£è¾“å‡ºï¼š**
```
*** STARTING MOTOR *** (Start command #1)
Motor will run for 5000 milliseconds
Motor auto-stop timer set: start_time=12345, duration=5000 ms, target_ticks=75
Motor running: 1000/5000 ms (ticks: 15)
Motor running: 2000/5000 ms (ticks: 30)
Motor running: 3000/5000 ms (ticks: 45)
Motor running: 4000/5000 ms (ticks: 60)
Motor running: 5000/5000 ms (ticks: 75)
*** Motor auto-stop triggered after 5001 milliseconds ***
Motor stopped and auto-stop timer cleared
```

#### **æ‰‹åŠ¨åœæ­¢å‘½ä»¤æµ‹è¯•**
```json
// 1. å¯åŠ¨10ç§’è¿è¡Œ
{
  "paras": {
    "enable": true,
    "speed": 60,
    "duration": 10000
  }
}

// 2. 3ç§’åæ‰‹åŠ¨åœæ­¢
{
  "paras": {
    "enable": false
  }
}
```

**é¢„æœŸä¸²å£è¾“å‡ºï¼š**
```
*** STARTING MOTOR *** (Start command #1)
Motor will run for 10000 milliseconds
Motor auto-stop timer set: start_time=12345, duration=10000 ms
Motor running: 1000/10000 ms (ticks: 15)
Motor running: 2000/10000 ms (ticks: 30)
Motor running: 3000/10000 ms (ticks: 45)
*** STOPPING MOTOR *** (Stop command #1)  // ç”¨æˆ·æ‰‹åŠ¨åœæ­¢
Motor stopped and auto-stop timer cleared
```

## ğŸ” **è°ƒè¯•å’ŒéªŒè¯æ­¥éª¤**

### **æ­¥éª¤1ï¼šçƒ§å½•æ–°å›ºä»¶**
1. çƒ§å½•ç¼–è¯‘å¥½çš„å›ºä»¶åˆ°è®¾å¤‡
2. é‡å¯è®¾å¤‡ï¼Œè§‚å¯Ÿç³»ç»Ÿå¯åŠ¨æ—¥å¿—

### **æ­¥éª¤2ï¼šæµ‹è¯•åŸºæœ¬é©¬è¾¾æ§åˆ¶**
```json
// æµ‹è¯•1ï¼šçŸ­æ—¶é—´è¿è¡Œï¼ˆ2ç§’ï¼‰
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": true,
    "speed": 50,
    "direction": 1,
    "duration": 2000
  }
}
```

**éªŒè¯ç‚¹ï¼š**
- âœ… é©¬è¾¾å¼€å§‹è½¬åŠ¨
- âœ… æ¯ç§’æ˜¾ç¤ºè¿è¡Œè¿›åº¦
- âœ… 2ç§’åè‡ªåŠ¨åœæ­¢
- âœ… æ˜¾ç¤º"Motor auto-stop triggered"

### **æ­¥éª¤3ï¼šæµ‹è¯•æ‰‹åŠ¨åœæ­¢**
```json
// æµ‹è¯•2ï¼šé•¿æ—¶é—´è¿è¡Œ + æ‰‹åŠ¨åœæ­¢
{
  "paras": {
    "enable": true,
    "speed": 70,
    "duration": 15000  // 15ç§’
  }
}

// ç­‰å¾…3-5ç§’åå‘é€åœæ­¢å‘½ä»¤
{
  "paras": {
    "enable": false
  }
}
```

**éªŒè¯ç‚¹ï¼š**
- âœ… é©¬è¾¾å¼€å§‹è½¬åŠ¨
- âœ… æ˜¾ç¤ºè¿è¡Œè¿›åº¦
- âœ… åœæ­¢å‘½ä»¤ç«‹å³ç”Ÿæ•ˆ
- âœ… æ˜¾ç¤º"STOPPING MOTOR"
- âœ… é©¬è¾¾ç«‹å³åœæ­¢è½¬åŠ¨

### **æ­¥éª¤4ï¼šæµ‹è¯•ç³»ç»Ÿå“åº”æ€§**
åœ¨é©¬è¾¾è¿è¡ŒæœŸé—´æµ‹è¯•å…¶ä»–åŠŸèƒ½ï¼š
- å‘é€èœ‚é¸£å™¨å‘½ä»¤
- å‘é€RGB LEDå‘½ä»¤
- è§‚å¯Ÿä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°

**éªŒè¯ç‚¹ï¼š**
- âœ… æ‰€æœ‰å‘½ä»¤éƒ½èƒ½æ­£å¸¸å“åº”
- âœ… ä¼ æ„Ÿå™¨æ•°æ®æŒç»­æ›´æ–°
- âœ… MQTTæ¶ˆæ¯æ­£å¸¸å¤„ç†

## ğŸš¨ **æ•…éšœæ’é™¤**

### **é—®é¢˜1ï¼šé©¬è¾¾ä»ç„¶ä¸åœæ­¢**
**å¯èƒ½åŸå› ï¼š**
- PWMç¡¬ä»¶é—®é¢˜
- é©¬è¾¾é©±åŠ¨ç”µè·¯é—®é¢˜
- ç”µæºé—®é¢˜

**è°ƒè¯•æ­¥éª¤ï¼š**
1. æ£€æŸ¥ä¸²å£æ˜¯å¦æ˜¾ç¤º"Motor stopped"
2. ç”¨ä¸‡ç”¨è¡¨æµ‹é‡PWMè¾“å‡ºå¼•è„šç”µå‹
3. æ£€æŸ¥é©¬è¾¾é©±åŠ¨ç”µè·¯è¿æ¥

### **é—®é¢˜2ï¼šå®šæ—¶ä¸å‡†ç¡®**
**å¯èƒ½åŸå› ï¼š**
- ç³»ç»Ÿæ—¶é’Ÿé…ç½®é—®é¢˜
- ä¸»å¾ªç¯æ‰§è¡Œé¢‘ç‡é—®é¢˜

**è°ƒè¯•æ­¥éª¤ï¼š**
1. è§‚å¯Ÿè°ƒè¯•è¾“å‡ºä¸­çš„æ—¶é—´æˆ³
2. æ£€æŸ¥`OS_SYS_CLOCK`å€¼æ˜¯å¦æ­£ç¡®
3. éªŒè¯ä¸»å¾ªç¯æ‰§è¡Œé¢‘ç‡ï¼ˆåº”è¯¥æ˜¯15Hzï¼‰

### **é—®é¢˜3ï¼šåœæ­¢å‘½ä»¤æ— å“åº”**
**å¯èƒ½åŸå› ï¼š**
- JSONæ ¼å¼é”™è¯¯
- MQTTè¿æ¥é—®é¢˜
- å‘½ä»¤è§£æé—®é¢˜

**è°ƒè¯•æ­¥éª¤ï¼š**
1. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º"=== MOTOR CONTROL COMMAND ==="
2. éªŒè¯JSONæ ¼å¼å’Œå‚æ•°ç±»å‹
3. æ£€æŸ¥MQTTè¿æ¥çŠ¶æ€

## ğŸ“Š **æ€§èƒ½æŒ‡æ ‡**

ä¿®å¤åçš„ç³»ç»Ÿæ€§èƒ½ï¼š
- **å“åº”æ—¶é—´**ï¼šåœæ­¢å‘½ä»¤å“åº” < 100ms
- **å®šæ—¶ç²¾åº¦**ï¼šÂ±100msï¼ˆå—ä¸»å¾ªç¯66.7mså‘¨æœŸé™åˆ¶ï¼‰
- **ç³»ç»Ÿè´Ÿè½½**ï¼šå¢åŠ  < 1% CPUå ç”¨
- **å†…å­˜å ç”¨**ï¼šå¢åŠ 12å­—èŠ‚ï¼ˆ3ä¸ªå…¨å±€å˜é‡ï¼‰

## ğŸ‰ **æ€»ç»“**

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š
1. **é©¬è¾¾åœæ­¢**ï¼šä½¿ç”¨`IoTPwmStop()`å®Œå…¨åœæ­¢PWM
2. **ç³»ç»Ÿé˜»å¡**ï¼šç”¨éé˜»å¡å®šæ—¶å™¨æ›¿ä»£`LOS_Msleep()`
3. **å®æ—¶æ§åˆ¶**ï¼šåœ¨ä¸»å¾ªç¯ä¸­å®šæœŸæ£€æŸ¥å®šæ—¶å™¨

ç°åœ¨é©¬è¾¾æ§åˆ¶ç³»ç»Ÿå…·æœ‰ï¼š
- âœ… **å¯é åœæ­¢**ï¼šé©¬è¾¾èƒ½å¤Ÿå®Œå…¨åœæ­¢
- âœ… **ç²¾ç¡®å®šæ—¶**ï¼šè‡ªåŠ¨åœæ­¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… **å®æ—¶å“åº”**ï¼šéšæ—¶å¯ä»¥æ‰‹åŠ¨åœæ­¢
- âœ… **ç³»ç»Ÿç¨³å®š**ï¼šä¸å½±å“å…¶ä»–åŠŸèƒ½è¿è¡Œ

**é©¬è¾¾æ§åˆ¶é—®é¢˜å·²å®Œå…¨è§£å†³ï¼** ğŸš€
