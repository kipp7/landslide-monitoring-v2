# é©¬è¾¾å®šæ—¶å™¨ä¿®å¤æµ‹è¯•æŒ‡å—

## ğŸ”§ **ä¿®å¤å†…å®¹æ€»ç»“**

### **å…³é”®ä¿®å¤**
1. **æ—¶é’Ÿè®¡ç®—ä¿®å¤**ï¼šä¿®æ­£äº†tickåˆ°æ¯«ç§’çš„è½¬æ¢å…¬å¼
2. **å®šæ—¶å™¨æ£€æŸ¥å¢å¼º**ï¼šæ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
3. **é©¬è¾¾åœæ­¢æ–¹æ³•**ï¼šä½¿ç”¨`IoTPwmStop()`å®Œå…¨åœæ­¢PWM

### **ä¿®å¤å‰åå¯¹æ¯”**
```c
// âŒ ä¿®å¤å‰ï¼ˆé”™è¯¯çš„æ—¶é’Ÿè®¡ç®—ï¼‰
uint32_t elapsed_ms = elapsed_ticks * 1000 / OS_SYS_CLOCK;  // OS_SYS_CLOCK = 96MHz
// ç»“æœï¼š5000ms è®¡ç®—å‡º target_ticks=3258630 (é”™è¯¯ï¼)

// âœ… ä¿®å¤åï¼ˆæ­£ç¡®çš„æ—¶é’Ÿè®¡ç®—ï¼‰
uint32_t elapsed_ms = elapsed_ticks;  // åœ¨rk2206ä¸Šï¼Œ1 tick = 1 ms
// ç»“æœï¼š5000ms è®¡ç®—å‡º target_ticks=5000 (æ­£ç¡®ï¼)
```

## ğŸ¯ **æµ‹è¯•æ­¥éª¤**

### **æ­¥éª¤1ï¼šçƒ§å½•æ–°å›ºä»¶**
1. çƒ§å½•ç¼–è¯‘å¥½çš„å›ºä»¶åˆ°è®¾å¤‡
2. é‡å¯è®¾å¤‡ï¼Œè§‚å¯Ÿç³»ç»Ÿå¯åŠ¨

### **æ­¥éª¤2ï¼šæµ‹è¯•5ç§’è‡ªåŠ¨åœæ­¢**
å‘é€ä»¥ä¸‹å‘½ä»¤ï¼š
```json
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": true,
    "speed": 100,
    "direction": 1,
    "duration": 5000
  }
}
```

### **é¢„æœŸä¸²å£è¾“å‡º**
```
=== MOTOR CONTROL COMMAND ===
*** STARTING MOTOR *** (Start command #1)
Motor will run for 5000 milliseconds
Motor auto-stop timer set: start_time=792490, duration=5000 ms, target_ticks=5000

Motor_CheckAutoStop called #1 (auto_stop_enabled=true)
Motor running: 1000/5000 ms (ticks: 1000)
Motor_CheckAutoStop called #16 (auto_stop_enabled=true)
Motor running: 2000/5000 ms (ticks: 2000)
Motor_CheckAutoStop called #31 (auto_stop_enabled=true)
Motor running: 3000/5000 ms (ticks: 3000)
Motor_CheckAutoStop called #46 (auto_stop_enabled=true)
Motor running: 4000/5000 ms (ticks: 4000)
Motor_CheckAutoStop called #61 (auto_stop_enabled=true)
Motor running: 5000/5000 ms (ticks: 5000)
*** Motor auto-stop triggered after 5000 milliseconds ***
Motor stopped and auto-stop timer cleared
```

### **æ­¥éª¤3ï¼šéªŒè¯é©¬è¾¾å®é™…åœæ­¢**
- âœ… **é©¬è¾¾åº”è¯¥å®Œå…¨åœæ­¢è½¬åŠ¨**
- âœ… **ä¸²å£æ˜¾ç¤º"Motor auto-stop triggered"**
- âœ… **æ—¶é—´åº”è¯¥æ¥è¿‘5ç§’ï¼ˆÂ±100msè¯¯å·®æ­£å¸¸ï¼‰**

### **æ­¥éª¤4ï¼šæµ‹è¯•æ‰‹åŠ¨åœæ­¢**
```json
// 1. å¯åŠ¨é•¿æ—¶é—´è¿è¡Œ
{
  "paras": {
    "enable": true,
    "speed": 80,
    "duration": 10000
  }
}

// 2. ç­‰å¾…2-3ç§’åå‘é€åœæ­¢å‘½ä»¤
{
  "paras": {
    "enable": false
  }
}
```

### **é¢„æœŸç»“æœ**
```
*** STARTING MOTOR *** (Start command #2)
Motor will run for 10000 milliseconds
Motor auto-stop timer set: start_time=800000, duration=10000 ms, target_ticks=10000

Motor_CheckAutoStop called #76 (auto_stop_enabled=true)
Motor running: 1000/10000 ms (ticks: 1000)
Motor_CheckAutoStop called #91 (auto_stop_enabled=true)
Motor running: 2000/10000 ms (ticks: 2000)

*** STOPPING MOTOR *** (Stop command #1)  // æ‰‹åŠ¨åœæ­¢
Motor stopped and auto-stop timer cleared
```

## ğŸ” **è°ƒè¯•ä¿¡æ¯è§£è¯»**

### **æ­£å¸¸çš„è°ƒè¯•è¾“å‡º**
1. **å‡½æ•°è°ƒç”¨ç¡®è®¤**ï¼š`Motor_CheckAutoStop called #X`
2. **è¿è¡Œè¿›åº¦æ˜¾ç¤º**ï¼š`Motor running: X/5000 ms`
3. **è‡ªåŠ¨åœæ­¢è§¦å‘**ï¼š`Motor auto-stop triggered after X milliseconds`
4. **å®šæ—¶å™¨æ¸…ç†**ï¼š`Motor stopped and auto-stop timer cleared`

### **å¼‚å¸¸æƒ…å†µè¯Šæ–­**

#### **æƒ…å†µ1ï¼šæ²¡æœ‰çœ‹åˆ°è°ƒè¯•è¾“å‡º**
```
*** STARTING MOTOR ***
Motor will run for 5000 milliseconds
Motor auto-stop timer set: start_time=X, duration=5000 ms, target_ticks=5000
// ç„¶åæ²¡æœ‰ä»»ä½•Motor_CheckAutoStopçš„è¾“å‡º
```
**å¯èƒ½åŸå› **ï¼šä¸»å¾ªç¯æ²¡æœ‰è°ƒç”¨`Motor_CheckAutoStop()`
**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ä¼ æ„Ÿå™¨é‡‡é›†ä»»åŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

#### **æƒ…å†µ2ï¼šæ—¶é—´è®¡ç®—ä»ç„¶é”™è¯¯**
```
Motor auto-stop timer set: start_time=X, duration=5000 ms, target_ticks=3258630
```
**å¯èƒ½åŸå› **ï¼šæ—¶é’Ÿè®¡ç®—ä¿®å¤æ²¡æœ‰ç”Ÿæ•ˆ
**è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°ç¼–è¯‘å¹¶çƒ§å½•å›ºä»¶

#### **æƒ…å†µ3ï¼šé©¬è¾¾ä¸åœæ­¢**
```
Motor running: 5000/5000 ms (ticks: 5000)
*** Motor auto-stop triggered after 5000 milliseconds ***
Motor stopped and auto-stop timer cleared
// ä½†é©¬è¾¾ä»åœ¨è½¬åŠ¨
```
**å¯èƒ½åŸå› **ï¼šPWMåœæ­¢å‡½æ•°é—®é¢˜æˆ–ç¡¬ä»¶é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥PWMç¡¬ä»¶è¿æ¥

## ğŸ“Š **æ€§èƒ½éªŒè¯**

### **å®šæ—¶ç²¾åº¦æµ‹è¯•**
| è®¾å®šæ—¶é—´ | å®é™…åœæ­¢æ—¶é—´ | è¯¯å·® | çŠ¶æ€ |
|----------|--------------|------|------|
| 2000ms   | 2001-2066ms  | â‰¤66ms | âœ… æ­£å¸¸ |
| 5000ms   | 5001-5066ms  | â‰¤66ms | âœ… æ­£å¸¸ |
| 10000ms  | 10001-10066ms| â‰¤66ms | âœ… æ­£å¸¸ |

**æ³¨æ„**ï¼šç”±äºä¸»å¾ªç¯66.7msçš„å‘¨æœŸï¼Œè¯¯å·®åœ¨Â±66msèŒƒå›´å†…æ˜¯æ­£å¸¸çš„ã€‚

### **ç³»ç»Ÿå“åº”æ€§æµ‹è¯•**
åœ¨é©¬è¾¾è¿è¡ŒæœŸé—´æµ‹è¯•ï¼š
- âœ… å‘é€èœ‚é¸£å™¨å‘½ä»¤åº”è¯¥æ­£å¸¸å“åº”
- âœ… å‘é€RGB LEDå‘½ä»¤åº”è¯¥æ­£å¸¸å“åº”
- âœ… ä¼ æ„Ÿå™¨æ•°æ®åº”è¯¥æŒç»­æ›´æ–°
- âœ… MQTTæ¶ˆæ¯åº”è¯¥æ­£å¸¸å¤„ç†

## ğŸš¨ **æ•…éšœæ’é™¤**

### **é—®é¢˜1ï¼šç¼–è¯‘åä»ç„¶ä¸å·¥ä½œ**
**æ£€æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤å›ºä»¶å·²æ­£ç¡®çƒ§å½•
2. é‡å¯è®¾å¤‡
3. æ£€æŸ¥ä¸²å£æ³¢ç‰¹ç‡è®¾ç½®
4. éªŒè¯MQTTè¿æ¥çŠ¶æ€

### **é—®é¢˜2ï¼šå®šæ—¶ä¸å‡†ç¡®**
**å¯èƒ½åŸå› **ï¼š
- ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
- ä¸»å¾ªç¯è¢«å…¶ä»–ä»»åŠ¡é˜»å¡
- æ—¶é’Ÿæºä¸ç¨³å®š

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç³»ç»ŸCPUå ç”¨ç‡
- ä¼˜åŒ–å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
- éªŒè¯ç³»ç»Ÿæ—¶é’Ÿé…ç½®

### **é—®é¢˜3ï¼šé©¬è¾¾ç¡¬ä»¶é—®é¢˜**
**æ£€æŸ¥æ­¥éª¤**ï¼š
1. ç”¨ä¸‡ç”¨è¡¨æµ‹é‡PWMè¾“å‡ºå¼•è„š
2. æ£€æŸ¥é©¬è¾¾é©±åŠ¨ç”µè·¯
3. éªŒè¯ç”µæºä¾›åº”
4. æµ‹è¯•é©¬è¾¾æœ¬èº«

## ğŸ‰ **æˆåŠŸæ ‡å‡†**

ä¿®å¤æˆåŠŸçš„æ ‡å¿—ï¼š
- âœ… **ç²¾ç¡®å®šæ—¶**ï¼š5ç§’å®šæ—¶è¯¯å·® < 100ms
- âœ… **å®Œå…¨åœæ­¢**ï¼šé©¬è¾¾ç‰©ç†åœæ­¢è½¬åŠ¨
- âœ… **å®æ—¶æ§åˆ¶**ï¼šæ‰‹åŠ¨åœæ­¢å‘½ä»¤ç«‹å³ç”Ÿæ•ˆ
- âœ… **ç³»ç»Ÿç¨³å®š**ï¼šå…¶ä»–åŠŸèƒ½ä¸å—å½±å“
- âœ… **è°ƒè¯•æ¸…æ™°**ï¼šä¸²å£è¾“å‡ºè¯¦ç»†çš„è¿è¡ŒçŠ¶æ€

å¦‚æœä»¥ä¸Šæ‰€æœ‰æ ‡å‡†éƒ½æ»¡è¶³ï¼Œè¯´æ˜é©¬è¾¾å®šæ—¶å™¨é—®é¢˜å·²å®Œå…¨è§£å†³ï¼ğŸš€

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

å¦‚æœæµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. å®Œæ•´çš„ä¸²å£è¾“å‡ºæ—¥å¿—
2. å‘é€çš„å…·ä½“å‘½ä»¤å†…å®¹
3. é©¬è¾¾çš„å®é™…è¡Œä¸ºæè¿°
4. ç³»ç»Ÿå…¶ä»–åŠŸèƒ½çš„å·¥ä½œçŠ¶æ€

è¿™æ ·å¯ä»¥æ›´å‡†ç¡®åœ°å®šä½å’Œè§£å†³é—®é¢˜ã€‚
