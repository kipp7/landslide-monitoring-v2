 华为云IotData之应用侧对接

物联网平台把自身丰富的管理能力通过API的形式对外开放，包括产品管理、设备管理、设备组管理、标签管理、设备CA证书管理、设备影子、设备命令、设备消息、设备属性、订阅管理、规则管理、批量任务等，帮助用户快速构筑基于物联网平台的行业应用。
详见参考文档：https://support.huaweicloud.com/api-iothub/iot_06_v5_0001.html
身份鉴权

调用接口之前需要进行身份鉴权，有2种方式，token鉴权或AK/SK鉴权。
1、接口说明

接口地址：https://iam.cn-north-4.myhuaweicloud.com/v3/auth/tokens

请求方式：POST

请求头：Content-Type: application/json 

请求体：

{ 
    "auth": { 
        "identity": { 
            "methods": [ 
                "password"  
            ], 
            "password": { 
                "user": { 
                    "name": "username", 
                    "password": "password", 
                    "domain": { 
                        "name": "domainname"
                    } 
                } 
            } 
        }, 
        "scope": { 
            "project": { 
                "name": "projectname"
            } 
        } 
    } 
}

参数说明：

    methods：集合里面只有一个选项“password”。

    user：这里的username、password，是IAM账户的信息，domainname是华为云账户。

    projectname：是项目名称。

参数获取可以参考下图。
图片


2、在线调试

鉴权的目的是为了获取token，其它接口需要使用token作为header。

鉴权说明文档：https://support.huaweicloud.com/api-iothub/iot_06_v5_0091.html

在线接口调试：https://console.huaweicloud.com/apiexplorer/#/openapi/IAM/doc?api=KeystoneCreateUserTokenByPassword&version=v3

调试要点：

    选择自己账号所在区域：这里通晓开发板设备位于华北-北京四。

    选择 methods：password（只有这一个选项）

    domain.name：也就是IMA账号所属的管理员账户，也就是华为账户。

    name/password：IMA账号和密码。

在线调试，调试结果如下。
图片


获取设备数据

设备影子是一个用于存储和检索设备当前状态信息的JSON文档。应用侧可调用此接口查询指定设备的设备影子信息，获取设备最新上报的属性信息。
1、接口说明

接口参考文档：https://support.huaweicloud.com/api-iothub/iot_06_v5_0079.html

接口地址：/v5/iot/{project_id}/devices/{device_id}/shadow

请求方式：GET

路径参数：

    project_id：项目id。在我的凭证中进行查看。

    device_id：设备id。在设备详情中进行查看。

请求头：

    X-Auth-Token：身份鉴权获得的token值。

响应格式：

{
  "device_id" : "40fe3542-f4cc-4b6a-98c3-61a49ba1acd4",
  "shadow" : [ {
    "service_id" : "WaterMeter",
    "desired" : {
      "properties" : {
        "temperature" : "60"
      },
      "event_time" : "20151212T121212Z"
    },
    "reported" : {
      "properties" : {
        "temperature" : "60"
      },
      "event_time" : "20151212T121212Z"
    },
    "version" : 1
  } ]
}


2、在线调试

在线接口调试地址：https://console.huaweicloud.com/apiexplorer/#/openapi/IoTDA/debug?api=ShowDeviceShadow

调试成功示意图如下：
图片


响应结果如下：

{
"device_id": "67ff4f679314d1185112ac5a_smartcar",
"shadow": [
  {
   "service_id": "IntelligentCockpit",
   "desired": {
    "properties": null,
    "event_time": null
   },
   "reported": {
    "properties": {
     "illumination": "305.00Lux",
     "temperature": "30.46℃",
     "humidity": "42.00%",
     "motorStatus": "OFF",
     "lightStatus": "ON",
     "autoStatus": "OFF"
    },
    "event_time": "20250427T090319Z"
   },
   "version": 8011
  }
 ]
}


设备控制

IoTData平台可向设备下发的命令，应用侧可调用此接口向指定设备下发命令，以实现对设备的同步控制。平台负责将命令以同步方式发送给设备，并将设备执行命令结果同步返回, 如果设备没有响应，平台会返回给应用服务器超时，平台超时时间是20秒。如果命令下发需要超过20秒，最好使用消息下发的形式。
1、接口说明

接口参考文档：https://support.huaweicloud.com/api-iothub/iot_06_v5_0038.html

请求接口：/v5/iot/{project_id}/devices/{device_id}/commands

请求方式：POST

路径参数：

    project_id：项目id，在个人凭证中进行查看。

    device_id：在设备详情中进行查看。

请求参数，参考示例如下：

{
"service_id": "IntelligentCockpit",
"command_name": "light_control",
"paras": {
  "onoff": "ON"
 }
}

响应结果，参考示例如下：

{
"command_id": "c25d7661-3a28-4b90-82ba-5f4c2ad7544d",
"response": {
  "result_code": 0,
  "response_name": "COMMAND_RESPONSE",
  "paras": {
   "result": "success"
  }
 }
}

注意：

    此接口适用于MQTT设备同步命令下发，暂不支持NB-IoT设备命令下发。

    此接口仅支持单个设备同步命令下发，如需多个设备同步命令下发，需要使用批量任务创建。

批量任务接口：https://support.huaweicloud.com/api-iothub/iot_06_v5_0045.html


2、在线调试

注意，MQTT协议只支持同步下发命令，接口调试操作示意图如下。

在线接口调试：https://console.huaweicloud.com/apiexplorer/#/openapi/IoTDA/debug?api=CreateCommand
图片

应用侧对接
1、定义华为云相关参数

export  class  CommonConstant{
    static readonly IAM_ENDPOINT=""
    static readonly ENDPOINT=""
    static readonly project_id=""
    static readonly product_id: string=""
    static readonly device_id: string=""
    static readonly DOMAIN_USERNAME=""
    static readonly IAM_USERNAME=""
    static readonly IAM_PASSWORD=""
  static readonly AUTH_TOKEN=CommonConstant.IAM_ENDPOINT+"/v3/auth/tokens"
   //获取设备影子数据，也就是设备上报的数据
  static readonly SHOW_SHADOW=CommonConstant.ENDPOINT+"/v5/iot/"+CommonConstant.project_id+"/devices/"+CommonConstant.device_id+"/shadow"
  //控制设备-同步下发设备命令
  static readonly CONTROL_DEVICE_SYNC=CommonConstant.ENDPOINT+"/v5/iot/"+CommonConstant.project_id+"/devices/"+CommonConstant.device_id+"/commands"
}


2、登录鉴权测试

接口封装

login(): Promise<string> {
    return new Promise<string>((resolve, reject) => {
      let httpRequest=http.createHttp()
      httpRequest.request(CommonConstant.AUTH_TOKEN, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        },
        extraData: {
          "auth": {
            "identity": {
              "methods": [
                "password"
              ],
              "password": {
                "user": {
                  "name": CommonConstant.IAM_USERNAME,
                  "password": CommonConstant.IAM_PASSWORD,
                  "domain": {
                    "name": CommonConstant.DOMAIN_USERNAME
                  }
                }
              }
            },
            "scope": {
              "domain": {
                "name": CommonConstant.DOMAIN_USERNAME
              }
            }
          }
        }
      })
        .then((data: http.HttpResponse) => {
          if (data.responseCode==201) {
            //拿到 token，并保存起来
            let token: string=data.header['x-subject-token']
            console.info(TAG, "token="+token)
            CommonConstant.token=token
            resolve(token)
          } else {
            reject("请求失败")
          }
        })
        .catch((err:BusinessError) => {
          console.info(TAG, JSON.stringify(err))
          reject("网络请求错误")
        }).finally(() => {
        httpRequest.destroy()
      })
    })
  }

测试结果如下
图片


3、获取设备数据

接口封装

getLatestData(): Promise<string> {
    return new Promise<string>((resolve, reject) => {
      let httpRequest: http.HttpRequest=http.createHttp()
      let options: http.HttpRequestOptions= {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'x-auth-token': CommonConstant.token
        },
        expectDataType: http.HttpDataType.STRING, // 可选，指定返回数据的类型
      }
      httpRequest.request(CommonConstant.SHOW_SHADOW, options)
        .then((data) => {
          if (data.responseCode===200) {
            let result: string=JSON.stringify(data.result)
            console.info(TAG, "设备最新数据="+result)
            resolve(result)
          } else {
            reject("请求失败")
          }
        }).catch((err:BusinessError) => {
        console.info(TAG, JSON.stringify(err))
        reject("网络请求失败")
      }).finally(() => {
        httpRequest.destroy()
      })
    })
  }

测试结果如下
图片


4、控制设备

接口封装

controlDevice(params: object): Promise<string> {
    return new Promise<string>((resolve, reject) => {
      let httpRequest: http.HttpRequest=http.createHttp()
      let options: http.HttpRequestOptions= {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json',
          'x-auth-token': CommonConstant.token
        },
        expectDataType: http.HttpDataType.STRING, // 可选，指定返回数据的类型
        extraData: params
      }
      httpRequest.request(CommonConstant.CONTROL_DEVICE_SYNC, options)
        .then((data) => {
          if (data.responseCode===200&&data.result.toString().includes("command_id")) {
            console.info(TAG, "控制设备="+"控制成功")
            resolve("控制成功")
          } else {
            reject("操作失败")
          }
        }).catch((err:BusinessError) => {
        console.info(TAG, JSON.stringify(err))
        reject("网络请求失败")
      }).finally(() => {
        httpRequest.destroy()
      })
    })
  }

测试结果如下
图片




