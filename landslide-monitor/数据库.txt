create table public.iot_anomalies (
  id serial not null,
  event_time timestamp with time zone null default now(),
  device_id text not null,
  anomaly_type text not null,
  value double precision not null,
  raw_data jsonb not null,
  constraint iot_anomalies_pkey primary key (id)
) TABLESPACE pg_default;

create index IF not exists idx_iot_anomalies_device_id on public.iot_anomalies using btree (device_id) TABLESPACE pg_default;

create index IF not exists idx_iot_anomalies_event_time on public.iot_anomalies using btree (event_time) TABLESPACE pg_default;

create table public.device_mapping (
  id serial not null,
  simple_id text not null,
  actual_device_id text not null,
  device_name text not null,
  location_name text null,
  device_type text null default 'sensor'::text,
  latitude double precision null,
  longitude double precision null,
  install_date timestamp with time zone null default now(),
  status text null default 'active'::text,
  description text null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint device_mapping_pkey primary key (id),
  constraint device_mapping_actual_device_id_key unique (actual_device_id),
  constraint device_mapping_simple_id_key unique (simple_id)
) TABLESPACE pg_default;

create index IF not exists idx_device_mapping_simple_id on public.device_mapping using btree (simple_id) TABLESPACE pg_default;

create index IF not exists idx_device_mapping_actual_id on public.device_mapping using btree (actual_device_id) TABLESPACE pg_default;

create index IF not exists idx_device_mapping_status on public.device_mapping using btree (status) TABLESPACE pg_default;

create trigger trigger_update_device_mapping_timestamp BEFORE
update on device_mapping for EACH row
execute FUNCTION update_device_mapping_timestamp ();

create view public.device_mapping_view as
select
  dm.simple_id,
  dm.actual_device_id,
  dm.device_name,
  dm.location_name,
  dm.device_type,
  dm.latitude,
  dm.longitude,
  dm.status,
  dm.description,
  dm.install_date,
  (
    select
      iot_data.event_time
    from
      iot_data
    where
      iot_data.device_id = dm.actual_device_id
    order by
      iot_data.event_time desc
    limit
      1
  ) as last_data_time,
  case
    when dm.status = 'maintenance'::text then 'maintenance'::text
    when (
      (
        select
          iot_data.event_time
        from
          iot_data
        where
          iot_data.device_id = dm.actual_device_id
        order by
          iot_data.event_time desc
        limit
          1
      )
    ) > (now() - '00:05:00'::interval) then 'online'::text
    else 'offline'::text
  end as online_status
from
  device_mapping dm
where
  dm.status = 'active'::text
order by
  dm.simple_id;

create table public.iot_anomaly_trends (
  id serial not null,
  event_time timestamp with time zone null default now(),
  device_id text not null,
  anomaly_type text null,
  risk_level double precision not null,
  latitude double precision null,
  longitude double precision null,
  province text null,
  city text null,
  district text null,
  township text null,
  constraint iot_anomaly_trends_pkey primary key (id),
  constraint iot_anomaly_trends_device_id_key unique (device_id)
) TABLESPACE pg_default;

create index IF not exists idx_iot_anomaly_trends_device_id on public.iot_anomaly_trends using btree (device_id) TABLESPACE pg_default;

create index IF not exists idx_iot_anomaly_trends_risk_level on public.iot_anomaly_trends using btree (risk_level) TABLESPACE pg_default;

create table public.iot_command_templates (
  id serial not null,
  command_name text not null,
  display_name text not null,
  description text null,
  service_id text not null default 'smartHome'::text,
  parameters_schema jsonb null,
  category text null,
  is_active boolean null default true,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint iot_command_templates_pkey primary key (id),
  constraint iot_command_templates_command_name_key unique (command_name)
) TABLESPACE pg_default;

create index IF not exists idx_command_templates_category on public.iot_command_templates using btree (category) TABLESPACE pg_default;

create index IF not exists idx_command_templates_active on public.iot_command_templates using btree (is_active) TABLESPACE pg_default;

create table public.iot_data (
  id serial not null,
  event_time timestamp with time zone null default timezone ('Asia/Shanghai'::text, now()),
  device_id text not null,
  illumination double precision null,
  temperature double precision null,
  humidity double precision null,
  acceleration_x integer null,
  acceleration_y integer null,
  acceleration_z integer null,
  gyroscope_x integer null,
  gyroscope_y integer null,
  gyroscope_z integer null,
  mpu_temperature double precision null,
  latitude double precision null,
  longitude double precision null,
  acceleration_total double precision null,
  gyroscope_total double precision null,
  vibration integer null,
  risk_level double precision null,
  alarm_active boolean null default false,
  uptime integer null,
  angle_x double precision null,
  angle_y double precision null,
  angle_z double precision null,
  constraint iot_data_pkey primary key (id)
) TABLESPACE pg_default;

create index IF not exists idx_iot_data_risk_level on public.iot_data using btree (risk_level) TABLESPACE pg_default;

create index IF not exists idx_iot_data_alarm_active on public.iot_data using btree (alarm_active) TABLESPACE pg_default;

create index IF not exists idx_iot_data_latitude_longitude on public.iot_data using btree (latitude, longitude) TABLESPACE pg_default;

create trigger trigger_calculate_totals BEFORE INSERT
or
update on iot_data for EACH row
execute FUNCTION calculate_totals ();

create table public.iot_device_locations (
  id serial not null,
  device_id text not null,
  province text not null,
  city text not null,
  district text not null,
  township text not null,
  latitude double precision null,
  longitude double precision null,
  location_name text null,
  altitude double precision null,
  installation_site text null,
  constraint iot_device_locations_pkey primary key (id),
  constraint iot_device_locations_device_id_key unique (device_id)
) TABLESPACE pg_default;

create index IF not exists idx_iot_device_locations_device_id on public.iot_device_locations using btree (device_id) TABLESPACE pg_default;

create index IF not exists idx_iot_device_locations_lat_lng on public.iot_device_locations using btree (latitude, longitude) TABLESPACE pg_default;

create table public.iot_devices (
  id serial not null,
  device_id text not null,
  node_id text not null,
  product_id text not null,
  gateway_id text null,
  install_date timestamp with time zone null default now(),
  last_active timestamp with time zone null default now(),
  friendly_name text null,
  display_name text null,
  short_name text null,
  device_type text null default 'sensor'::text,
  manufacturer text null default '华为云IoT'::text,
  model text null,
  firmware_version text null default 'v1.0.0'::text,
  status text null default 'online'::text,
  constraint iot_devices_pkey primary key (id),
  constraint iot_devices_device_id_key unique (device_id)
) TABLESPACE pg_default;

create index IF not exists idx_iot_devices_device_id on public.iot_devices using btree (device_id) TABLESPACE pg_default;

create index IF not exists idx_iot_devices_last_active on public.iot_devices using btree (last_active) TABLESPACE pg_default;